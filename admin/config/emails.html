<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Marketing - MyCirkle Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="glass rounded-xl shadow-2xl p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">üìß Email Marketing Dashboard</h1>
                    <p class="text-gray-600 mt-1">Send marketing emails to your MyCirkle members</p>
                </div>
                <a href="../botconfig.html" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                    ‚Üê Back to Admin
                </a>
            </div>
        </div>

        <!-- Email Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="glass rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Total Members</p>
                        <p id="total-members" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="text-4xl">üë•</div>
                </div>
            </div>
            <div class="glass rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Emails Sent Today</p>
                        <p id="emails-today" class="text-3xl font-bold text-purple-600">0</p>
                    </div>
                    <div class="text-4xl">üì®</div>
                </div>
            </div>
            <div class="glass rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Monthly Quota</p>
                        <p class="text-3xl font-bold text-green-600">3,000</p>
                        <p class="text-xs text-gray-500">Free tier</p>
                    </div>
                    <div class="text-4xl">‚úâÔ∏è</div>
                </div>
            </div>
        </div>

        <!-- Compose Email -->
        <div class="glass rounded-xl shadow-2xl p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üìù Compose Marketing Email</h2>
            
            <div class="space-y-4">
                <!-- Recipients -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Send To:</label>
                    <select id="recipients" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="all">All Members</option>
                        <option value="active">Active Members (logged in last 30 days)</option>
                        <option value="high-points">High Point Members (500+ points)</option>
                        <option value="new">New Members (joined last 7 days)</option>
                        <option value="test">Test (Admin Only)</option>
                    </select>
                </div>

                <!-- Subject -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Subject Line:</label>
                    <input type="text" id="subject" placeholder="e.g., New Rewards Available! üéÅ" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>

                <!-- Email Template -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Email Template:</label>
                    <select id="template" onchange="loadTemplate()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 mb-3">
                        <option value="custom">Custom Message</option>
                        <option value="new-rewards">New Rewards Announcement</option>
                        <option value="points-reminder">Points Balance Reminder</option>
                        <option value="event">Event Invitation</option>
                        <option value="update">Platform Update</option>
                    </select>
                </div>

                <!-- Message Body -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Message:</label>
                    
                    <!-- Formatting Toolbar -->
                    <div class="bg-gray-100 border border-gray-300 rounded-t-lg px-3 py-2 flex items-center gap-2 flex-wrap">
                        <!-- Text Formatting -->
                        <button type="button" onclick="formatText('bold')" class="px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50 transition font-bold" title="Bold">
                            <strong>B</strong>
                        </button>
                        <button type="button" onclick="formatText('italic')" class="px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50 transition italic" title="Italic">
                            <em>I</em>
                        </button>
                        <button type="button" onclick="formatText('underline')" class="px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50 transition underline" title="Underline">
                            U
                        </button>
                        
                        <div class="w-px h-6 bg-gray-300"></div>
                        
                        <!-- List Formatting -->
                        <button type="button" onclick="formatText('bulletList')" class="px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50 transition" title="Bullet List">
                            ‚Ä¢ List
                        </button>
                        <button type="button" onclick="formatText('numberedList')" class="px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50 transition" title="Numbered List">
                            1. List
                        </button>
                        
                        <div class="w-px h-6 bg-gray-300"></div>
                        
                        <!-- Font Size -->
                        <div class="flex items-center gap-2 bg-white border border-gray-300 rounded px-3 py-1">
                            <label for="font-size" class="text-sm text-gray-600">Size:</label>
                            <input type="range" id="font-size" min="10" max="100" value="16" step="1" class="w-32" oninput="updateFontSizeDisplay(this.value)" onchange="applyFontSize(this.value)">
                            <span id="font-size-display" class="text-sm font-semibold w-12 text-center">16pt</span>
                        </div>
                        
                        <div class="w-px h-6 bg-gray-300"></div>
                        
                        <!-- Variables -->
                        <button type="button" onclick="insertVariable('firstName')" class="px-3 py-1 bg-purple-100 border border-purple-300 rounded hover:bg-purple-200 transition text-sm" title="Insert First Name">
                            {{firstName}}
                        </button>
                        <button type="button" onclick="insertVariable('points')" class="px-3 py-1 bg-blue-100 border border-blue-300 rounded hover:bg-blue-200 transition text-sm" title="Insert Points">
                            {{points}}
                        </button>
                    </div>
                    
                    <textarea id="message" rows="10" placeholder="Write your email message here... Use the toolbar above for formatting." class="w-full px-4 py-3 border border-gray-300 rounded-b-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" style="border-top: none; font-family: inherit;"></textarea>
                    <p class="text-xs text-gray-500 mt-2">üí° Pro tip: Select text and use the toolbar to format it. Variables {{firstName}} and {{points}} will be replaced with actual user data.</p>
                </div>

                <!-- Preview -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-700 mb-2">Preview:</h3>
                    <div id="preview" class="bg-white p-4 rounded border border-gray-300 min-h-[100px]">
                        <p class="text-gray-400 italic">Your email preview will appear here...</p>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-4">
                    <button onclick="sendEmail()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-4 rounded-lg font-bold text-lg transition">
                        üì® Send Email
                    </button>
                    <button onclick="clearForm()" class="bg-gray-400 hover:bg-gray-500 text-white px-8 py-4 rounded-lg font-semibold transition">
                        Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Send History -->
        <div class="glass rounded-xl shadow-2xl p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã Recent Emails</h2>
            <div id="email-history" class="space-y-3">
                <p class="text-gray-400 italic text-center py-8">No emails sent yet</p>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center">
            <div class="text-6xl mb-4">üìß</div>
            <h3 class="text-2xl font-bold mb-4">Sending Emails...</h3>
            <p class="text-gray-600 mb-6">This may take a moment</p>
            <div class="w-16 h-16 border-4 border-purple-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center">
            <div class="text-green-500 text-6xl mb-4">‚úÖ</div>
            <h3 class="text-2xl font-bold mb-4">Emails Sent!</h3>
            <p class="text-gray-600 mb-6" id="success-message">Your emails have been sent successfully</p>
            <button onclick="closeSuccessModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-lg font-semibold transition">
                Close
            </button>
        </div>
    </div>

    <script>
        const WORKER_URL = 'https://mycirkle-auth.marcusray.workers.dev';
        
        // Email templates
        const templates = {
            'new-rewards': {
                subject: 'üéÅ New Rewards Available in MyCirkle!',
                message: `Hi {{firstName}},

Exciting news! We've just added brand new rewards to MyCirkle! üéâ

You currently have {{points}} points ready to redeem. Check out our new rewards:

‚ú® Exclusive discount codes
üéÆ Free gaming items
üöö Free shipping vouchers
‚≠ê And much more!

Visit your dashboard now to see what you can get:
https://my.cirkledevelopment.co.uk

Thank you for being part of the MyCirkle family! üíú

- The Cirkle Development Team`
            },
            'points-reminder': {
                subject: 'üí∞ You have {{points}} points waiting in MyCirkle!',
                message: `Hey {{firstName}},

Just a friendly reminder that you have {{points}} points in your MyCirkle account! üéØ

Don't let them sit there - redeem them for awesome rewards:
- Discount codes
- Free shipping
- Exclusive perks
- And more!

Login to your dashboard:
https://my.cirkledevelopment.co.uk

Happy redeeming! üéÅ

- The Cirkle Development Team`
            },
            'event': {
                subject: 'üéâ You\'re Invited: Special MyCirkle Event!',
                message: `Hi {{firstName}},

You're invited to our special MyCirkle event! üéä

Join us for exclusive giveaways, bonus points, and special rewards available only during the event.

üìÖ Event Details:
‚Ä¢ When: [Add date/time]
‚Ä¢ Where: Discord Server
‚Ä¢ What: Giveaways, Bonus Points, Exclusive Rewards

Your current balance: {{points}} points

Join the event:
[Add Discord invite link]

See you there! üöÄ

- The Cirkle Development Team`
            },
            'update': {
                subject: 'üì¢ MyCirkle Platform Update',
                message: `Hello {{firstName}},

We've made some exciting updates to MyCirkle! üîß

What's New:
‚Ä¢ [Feature 1]
‚Ä¢ [Feature 2]
‚Ä¢ [Feature 3]

These improvements make earning and redeeming your {{points}} points even easier!

Check out the updates:
https://my.cirkledevelopment.co.uk

As always, thank you for your continued support! üíú

- The Cirkle Development Team`
            }
        };

        // Load template
        function loadTemplate() {
            const templateId = document.getElementById('template').value;
            if (templateId === 'custom') {
                document.getElementById('subject').value = '';
                document.getElementById('message').value = '';
                return;
            }
            
            const template = templates[templateId];
            document.getElementById('subject').value = template.subject;
            document.getElementById('message').value = template.message;
            updatePreview();
        }

        // Update preview
        function updatePreview() {
            const subject = document.getElementById('subject').value;
            const message = document.getElementById('message').value;
            
            // Convert newlines to <br> and preserve HTML tags
            const formattedMessage = message
                .replace(/{{firstName}}/g, '<span class="bg-yellow-200 px-1 rounded">John</span>')
                .replace(/{{points}}/g, '<span class="bg-blue-200 px-1 rounded">250</span>')
                .replace(/\n/g, '<br>');
            
            const previewHTML = `
                <div class="border-b pb-3 mb-3">
                    <p class="text-xs text-gray-500 mb-1">Subject:</p>
                    <p class="font-bold">${subject || '(No subject)'}</p>
                </div>
                <div class="text-sm" style="line-height: 1.6;">${formattedMessage || '(No message)'}</div>
            `;
            document.getElementById('preview').innerHTML = previewHTML;
        }

        // Listen to input changes
        document.getElementById('subject').addEventListener('input', updatePreview);
        document.getElementById('message').addEventListener('input', updatePreview);
        
        // Text formatting functions
        function formatText(type) {
            const textarea = document.getElementById('message');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            if (!selectedText) {
                alert('Please select some text first!');
                return;
            }
            
            let formattedText = '';
            
            switch(type) {
                case 'bold':
                    formattedText = `<b>${selectedText}</b>`;
                    break;
                case 'italic':
                    formattedText = `<i>${selectedText}</i>`;
                    break;
                case 'underline':
                    formattedText = `<u>${selectedText}</u>`;
                    break;
                case 'bulletList':
                    const bulletLines = selectedText.split('\n').map(line => line.trim() ? `‚Ä¢ ${line.trim()}` : '').filter(line => line).join('\n');
                    formattedText = bulletLines;
                    break;
                case 'numberedList':
                    const numberedLines = selectedText.split('\n').filter(line => line.trim()).map((line, i) => `${i + 1}. ${line.trim()}`).join('\n');
                    formattedText = numberedLines;
                    break;
            }
            
            textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
            textarea.focus();
            textarea.selectionStart = start;
            textarea.selectionEnd = start + formattedText.length;
            updatePreview();
        }
        
        function updateFontSizeDisplay(size) {
            document.getElementById('font-size-display').textContent = size + 'pt';
        }
        
        function applyFontSize(size) {
            const textarea = document.getElementById('message');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            if (!selectedText) {
                alert('Please select some text first!');
                document.getElementById('font-size').value = 16;
                updateFontSizeDisplay(16);
                return;
            }
            
            const formattedText = `<span style="font-size: ${size}pt;">${selectedText}</span>`;
            
            textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
            textarea.focus();
            textarea.selectionStart = start;
            textarea.selectionEnd = start + formattedText.length;
            updatePreview();
            
            // Reset slider
            document.getElementById('font-size').value = 16;
            updateFontSizeDisplay(16);
        }
        
        function insertVariable(varName) {
            const textarea = document.getElementById('message');
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            const variable = `{{${varName}}}`;
            
            textarea.value = textBefore + variable + textAfter;
            textarea.focus();
            textarea.selectionStart = cursorPos + variable.length;
            textarea.selectionEnd = cursorPos + variable.length;
            updatePreview();
        }

        // Send email
        async function sendEmail() {
            const recipients = document.getElementById('recipients').value;
            const subject = document.getElementById('subject').value;
            const message = document.getElementById('message').value;

            if (!subject || !message) {
                alert('Please fill in both subject and message fields!');
                return;
            }

            if (!confirm(`Are you sure you want to send this email to: ${recipients}?`)) {
                return;
            }

            // Show loading
            document.getElementById('loading-modal').classList.remove('hidden');

            try {
                const response = await fetch(`${WORKER_URL}/api/admin/send-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        recipients,
                        subject,
                        message,
                        adminKey: localStorage.getItem('adminKey') || prompt('Enter admin key:')
                    })
                });

                const result = await response.json();

                document.getElementById('loading-modal').classList.add('hidden');

                if (response.ok) {
                    document.getElementById('success-message').textContent = `Successfully sent ${result.sent || 0} emails!`;
                    document.getElementById('success-modal').classList.remove('hidden');
                    clearForm();
                    loadHistory();
                    loadStats();
                } else {
                    alert('Error: ' + (result.error || 'Failed to send emails'));
                }
            } catch (error) {
                document.getElementById('loading-modal').classList.add('hidden');
                alert('Network error: ' + error.message);
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('recipients').value = 'all';
            document.getElementById('subject').value = '';
            document.getElementById('message').value = '';
            document.getElementById('template').value = 'custom';
            updatePreview();
        }

        // Close success modal
        function closeSuccessModal() {
            document.getElementById('success-modal').classList.add('hidden');
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch(`${WORKER_URL}/api/admin/email-stats`);
                const stats = await response.json();
                
                document.getElementById('total-members').textContent = stats.totalMembers || 0;
                document.getElementById('emails-today').textContent = stats.emailsToday || 0;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load history
        async function loadHistory() {
            try {
                const response = await fetch(`${WORKER_URL}/api/admin/email-history`);
                const history = await response.json();
                
                if (history.emails && history.emails.length > 0) {
                    const historyHTML = history.emails.map(email => `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">${email.subject}</p>
                                    <p class="text-sm text-gray-600 mt-1">To: ${email.recipients} ‚Ä¢ Sent: ${email.sent} emails</p>
                                    <p class="text-xs text-gray-400 mt-2">${new Date(email.timestamp).toLocaleString()}</p>
                                </div>
                                <span class="text-green-500 text-2xl">‚úì</span>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('email-history').innerHTML = historyHTML;
                }
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }

        // Initialize
        loadStats();
        loadHistory();
    </script>
</body>
</html>
